#!/bin/bash

export __dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
export __dir="$(dirname ${__dir})"

pushd ${__dir} 2>&1 >> /dev/null
    echo "For more information, check: https://github.com/dice-cyfronet/migratio#configuration"

    echo "====="

    cp -i config.yml.example config.yml

    __name="$(cat config.yml | grep name: | awk '{print $2}')"
    __redis_url="$(cat config.yml | grep redis_url: | awk '{print $2}')"
    __namespace="$(cat config.yml | grep namespace: | awk '{print $2}')"

    echo "====="

    echo "Name/site_id of this compute site (current value: \"${__name}\", leave empty to use the same)"
    read __new_name
    echo "Redis/Sidekiq URL (current value: \"${__redis_url}\", leave empty to use the same)"
    read __new_redis_url
    echo "Redis/Sidekiq namespace (current value: \"${__namespace}\", leave empty to use the same)"
    read __new_namespace

    if [ ! -z "${__new_name}" ] && [ "${__name}" != "${__new_name}" ]; then
        sed -i "s/name:.*/name: ${__new_name}/g" config.yml
    fi
    if [ ! -z "${__new_redis_url}" ] && [ "${__redis_url}" != "${__new_redis_url}" ]; then
        sed -i "s/redis_url:.*/redis_url: ${__new_redis_url}/g" config.yml
    fi
    if [ ! -z "${__new_namespace}" ] && [ "${__namespace}" != "${__new_namespace}" ]; then
        sed -i "s/namespace:.*/namespace: ${__new_namespace}/g" config.yml
    fi

    echo "====="
    echo "Show config.yml"
    echo "-----"
    cat config.yml

popd 2>&1 >> /dev/null
